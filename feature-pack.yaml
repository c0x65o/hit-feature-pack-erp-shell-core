# Feature Pack: erp-shell-core
# Provides the dashboard shell (layout, sidebar, topbar, notifications) for HIT apps
# Also includes the table views system for user-customizable data table views

name: erp-shell-core
title: System Core
description: ERP shell core with sidebar, topbar, notifications, theme support, and table views system

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/table-views.ts
  exports:
    - tableViews
    - tableViewFilters
    - tableViewShares
    - tableViewsRelations
    - tableViewFiltersRelations
    - tableViewSharesRelations
    - principalTypeEnum
    - TableView
    - TableViewFilter
    - TableViewShare
    - InsertTableView
    - InsertTableViewFilter
    - InsertTableViewShare
    - FILTER_OPERATORS
    - FILTER_VALUE_TYPES
    - FilterOperator
    - FilterValueType
    - notificationReads
    - NotificationRead
    - InsertNotificationRead

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints for table views
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/notification-reads
      methods: [GET, POST]
      handler: "@hit/feature-pack-erp-shell-core/server/api/notification-reads"
      description: "Get or upsert notification read state for the current user"
    - path: /api/table-views
      methods: [GET, POST]
      handler: "@hit/feature-pack-erp-shell-core/server/api/table-views"
      description: "List views (GET) or create view (POST)"
    - path: /api/table-views/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-erp-shell-core/server/api/table-views-id"
      description: "Get, update, or delete a view"
    - path: /api/table-views/[id]/use
      methods: [PATCH]
      handler: "@hit/feature-pack-erp-shell-core/server/api/table-views-use"
      description: "Mark a view as used (update lastUsedAt)"
    - path: /api/table-views/[id]/shares
      methods: [GET, POST, DELETE]
      handler: "@hit/feature-pack-erp-shell-core/server/api/table-views-shares"
      description: "List, add, or remove share entries for a view"

    # Generic table data helpers (config-driven providers)
    - path: /api/table-data/batch
      methods: [POST]
      handler: "@hit/feature-pack-erp-shell-core/server/api/table-data-batch"
      description: "Fetch table rows by ids for a given tableId (uses provider registry)"

    - path: /api/table-data/grouped-buckets
      methods: [POST]
      handler: "@hit/feature-pack-erp-shell-core/server/api/table-data-grouped-buckets"
      description: "Fetch grouped rows for a segment bucket column (tableId+columnKey) via metrics-core + providers"

    # Dashboards + Reports moved to dedicated feature packs:
    # - @hit/feature-pack-dashboards owns /api/dashboard-definitions*

    # Nexus (AI routing) — compile-time pack options + tool surfaces
    - path: /api/nexus/options
      methods: [GET]
      handler: "@hit/feature-pack-erp-shell-core/server/api/nexus-options"
      description: "Nexus router options (enabled packs + titles/descriptions + agent prompts + nexus prompt)"
    - path: /api/nexus/tools
      methods: [GET]
      handler: "@hit/feature-pack-erp-shell-core/server/api/nexus-tools"
      description: "Tool surface for a given feature pack (from .hit/generated/capabilities.json)"

routes:
  - path: /logs/errors
    page: ErrorLog
    roles: []
    default_roles_allow: [admin]
    authz: { entity: logs, verb: read }
  - path: /logs/latency
    page: AppLatency
    roles: []
    default_roles_allow: [admin]
    authz: { entity: logs, verb: read }

nav:
  - id: logs
    label: Logs
    icon: FileText
    group: system
    weight: 900
    roles: [admin]
    showWhen: authenticated
    children:
      - id: logs-errors
        label: Error Log
        path: /logs/errors
        icon: AlertCircle
        weight: 100
        roles: [admin]
        showWhen: authenticated
      - id: logs-latency
        label: App Latency
        path: /logs/latency
        icon: Clock
        weight: 110
        roles: [admin]
        showWhen: authenticated

## Nav entry intentionally omitted for MVP:
## dashboards should be discovered from within the Projects feature pack (not global/root).

# No module dependencies
requires:
  modules: []

# Configurable options
config:
  schema:
    brand_name:
      type: string
      default: HIT
      description: Brand/app name shown in navigation
    logo_url:
      type: string
      default: /icon.png
      description: Logo image URL
    sidebar_position:
      type: string
      enum: [left, right]
      default: left
      description: Sidebar position
    show_notifications:
      type: boolean
      default: true
      description: Show notification bell in topbar
    show_theme_toggle:
      type: boolean
      default: true
      description: Show dark/light mode toggle
    show_user_menu:
      type: boolean
      default: true
      description: Show user menu in topbar
    default_theme:
      type: string
      enum: [light, dark, system]
      default: system
      description: Default theme mode
    nexus_prompt:
      type: string
      default: |
        You are Nexus.

        Users can ask a wide range of questions.

        Your job is to decide ONE of two outcomes:
        - respond directly (ONLY when the question is not about the HIT system), OR
        - route to exactly one HIT feature-pack agent (when the question is about the HIT system).

        Rules:
        - If any part of the request is about the HIT system (data, features, actions, dashboards, CRM, metrics, tasks, etc.), route it to the best matching pack agent.
        - Use pack titles/descriptions and the user's current page context to choose the right pack.
        - If the request is ambiguous OR is just a greeting with no HIT intent, respond directly with ONE clarifying question about what they want to do in HIT (do not route).
        - You NEVER execute tools. You NEVER call APIs. You ONLY decide/respond-or-route.

        Output MUST be valid JSON matching the required routing schema.
      description: System prompt used by the Nexus router (AI)
    nexus_debug:
      type: boolean
      default: false
      description: |
        Admin-only: when enabled, Nexus/pack agents may emit internal "pulse" debug events
        (routing decisions, intermediate summaries, agent handoffs). Never shown to non-admin users.
    # dashboards_enabled removed as part of dashboard system reset.

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Scope Policy Tree: erp-shell-core (global).
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - any: ignore scope (read everything)
    # - own: only owned records (not applicable for logs - logs are system-level)
    # - ldd: owner OR matching L/D/D (not applicable for logs - logs are system-level)
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    # Note: Logs pages are admin-only system pages. Scope modes are defined for consistency
    # with the entity+verb model, but in practice these pages require admin role.
    - key: erp-shell-core.read.scope.none
      label: "ERP Shell Core Read Scope = None"
      description: "Deny all ERP Shell Core read access."
      default_enabled: false
    - key: erp-shell-core.read.scope.any
      label: "ERP Shell Core Read Scope = Any"
      description: "Read all ERP Shell Core entities regardless of scope."
      default_enabled: false
    - key: erp-shell-core.read.scope.own
      label: "ERP Shell Core Read Scope = Own"
      description: "Read only ERP Shell Core entities you own (not applicable for logs - logs are system-level)."
      default_enabled: false
    - key: erp-shell-core.read.scope.ldd
      label: "ERP Shell Core Read Scope = LDD"
      description: "Read ERP Shell Core entities you own, or that match your L/D/D scope (not applicable for logs - logs are system-level)."
      default_enabled: false

    # Logs override (optional): if set, overrides erp-shell-core.read.scope.* for logs only.
    - key: erp-shell-core.logs.read.scope.none
      label: "ERP Shell Core Logs Read Scope = None"
      description: "Deny all log read access."
      default_enabled: false
    - key: erp-shell-core.logs.read.scope.any
      label: "ERP Shell Core Logs Read Scope = Any"
      description: "Read logs regardless of scope (admin-only in practice)."
      default_enabled: false
    - key: erp-shell-core.logs.read.scope.own
      label: "ERP Shell Core Logs Read Scope = Own"
      description: "Read only logs you own (not applicable - logs are system-level)."
      default_enabled: false
    - key: erp-shell-core.logs.read.scope.ldd
      label: "ERP Shell Core Logs Read Scope = LDD"
      description: "Read logs you own, or that match your L/D/D scope (not applicable - logs are system-level)."
      default_enabled: false
