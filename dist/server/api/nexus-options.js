import { NextResponse } from 'next/server';
import fs from 'node:fs';
import path from 'node:path';
import yaml from 'js-yaml';
import { extractUserFromRequest } from '../auth';
export const dynamic = 'force-dynamic';
export const runtime = 'nodejs';
function loadCapabilities(projectRoot) {
    try {
        const p = path.join(projectRoot, '.hit', 'generated', 'capabilities.json');
        if (!fs.existsSync(p))
            return null;
        const raw = fs.readFileSync(p, 'utf8');
        return JSON.parse(raw);
    }
    catch {
        return null;
    }
}
function loadHitConfig(projectRoot) {
    try {
        // Generated by `hit run` from the app's hit.yaml.
        const p = path.join(projectRoot, 'public', 'hit-config.json');
        if (!fs.existsSync(p))
            return null;
        const raw = fs.readFileSync(p, 'utf8');
        return JSON.parse(raw);
    }
    catch {
        return null;
    }
}
function loadDashboardShellDefaults(projectRoot) {
    // Try node_modules first (production), then monorepo workspace (dev).
    const candidates = [
        path.join(projectRoot, 'node_modules', '@hit', 'feature-pack-dashboard-shell', 'feature-pack.yaml'),
        path.join(projectRoot, '..', '..', 'hit-feature-packs', 'hit-feature-pack-dashboard-shell', 'feature-pack.yaml'),
    ];
    for (const p of candidates) {
        try {
            if (!fs.existsSync(p))
                continue;
            const raw = fs.readFileSync(p, 'utf8');
            const obj = yaml.load(raw);
            const schema = obj?.config?.schema;
            return schema && typeof schema === 'object' ? schema : null;
        }
        catch {
            // keep trying
        }
    }
    return null;
}
function isAdminUser(user) {
    const roles = Array.isArray(user?.roles) ? user.roles : [];
    return roles.some((r) => String(r || '').toLowerCase() === 'admin' || String(r || '').toLowerCase() === 'superadmin');
}
export async function GET(request) {
    const user = extractUserFromRequest(request);
    if (!user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }
    const projectRoot = process.cwd();
    const caps = loadCapabilities(projectRoot);
    const packs = Array.isArray(caps?.featurePacksDetailed) ? caps.featurePacksDetailed : [];
    const hitConfig = loadHitConfig(projectRoot);
    const shellCfg = hitConfig?.featurePacks?.['dashboard-shell'];
    const shellDefaults = loadDashboardShellDefaults(projectRoot);
    const defaultNexusPrompt = shellDefaults?.nexus_prompt?.default;
    const nexusPrompt = (shellCfg && typeof shellCfg.nexus_prompt === 'string' && String(shellCfg.nexus_prompt).trim()) ||
        (typeof defaultNexusPrompt === 'string' && defaultNexusPrompt.trim()) ||
        null;
    const debugFlag = shellCfg?.nexus_debug === true;
    const debugEnabled = Boolean(debugFlag && isAdminUser(user));
    return NextResponse.json({
        generated: Boolean(caps?.generated),
        kind: 'hit-nexus-options',
        nexusPrompt,
        debugEnabled,
        packs,
    });
}
